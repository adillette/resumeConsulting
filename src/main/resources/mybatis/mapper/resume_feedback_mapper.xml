<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.demo.dao.ResumeFeedbackDao">
    
    <!-- INSERT: 피드백 등록 -->
    <insert id="insertFeedback" parameterType="ResumeFeedback"
            useGeneratedKeys="true" keyProperty="feedbackId">
        INSERT INTO resume_feedbacks (
            resume_id,
            user_id,
            total_score,
            scores,
            strengths,
            weaknesses,
            improvements,
            sentence_feedbacks,
            keyword_analysis,
            career_analysis,
            job_match,
            summary,
            recommended_actions,
            feedback_type,
            analysis_version
        ) VALUES (
            #{resumeId},
            #{userId},
            #{totalScore},
            #{scores}::jsonb,
            #{strengths}::jsonb,
            #{weaknesses}::jsonb,
            #{improvements}::jsonb,
            #{sentenceFeedbacks}::jsonb,
            #{keywordAnalysis}::jsonb,
            #{careerAnalysis}::jsonb,
            #{jobMatch}::jsonb,
            #{summary},
            #{recommendedActions}::jsonb,
            #{feedbackType},
            #{analysisVersion}
        )
    </insert>
    
    <!-- SELECT: 피드백 조회 (단건) -->
    <select id="selectFeedbackById" parameterType="int" resultType="ResumeFeedback">
        SELECT 
            feedback_id AS feedbackId,
            resume_id AS resumeId,
            user_id AS userId,
            total_score AS totalScore,
            scores,
            strengths,
            weaknesses,
            improvements,
            sentence_feedbacks AS sentenceFeedbacks,
            keyword_analysis AS keywordAnalysis,
            career_analysis AS careerAnalysis,
            job_match AS jobMatch,
            summary,
            recommended_actions AS recommendedActions,
            feedback_type AS feedbackType,
            analysis_version AS analysisVersion,
            created_at AS createdAt,
            updated_at AS updatedAt
        FROM resume_feedbacks
        WHERE feedback_id = #{feedbackId}
    </select>
    
    <!-- SELECT: 이력서별 피드백 목록 조회 (최근순) -->
    <select id="selectFeedbacksByResumeId" parameterType="int" resultType="ResumeFeedback">
        SELECT 
            feedback_id AS feedbackId,
            resume_id AS resumeId,
            user_id AS userId,
            total_score AS totalScore,
            scores,
            strengths,
            weaknesses,
            improvements,
            sentence_feedbacks AS sentenceFeedbacks,
            keyword_analysis AS keywordAnalysis,
            career_analysis AS careerAnalysis,
            job_match AS jobMatch,
            summary,
            recommended_actions AS recommendedActions,
            feedback_type AS feedbackType,
            analysis_version AS analysisVersion,
            created_at AS createdAt,
            updated_at AS updatedAt
        FROM resume_feedbacks
        WHERE resume_id = #{resumeId}
        ORDER BY created_at DESC
    </select>
    
    <!-- SELECT: 사용자별 피드백 목록 조회 (최근순) -->
    <select id="selectFeedbacksByUserId" parameterType="int" resultType="ResumeFeedback">
        SELECT 
            feedback_id AS feedbackId,
            resume_id AS resumeId,
            user_id AS userId,
            total_score AS totalScore,
            scores,
            strengths,
            weaknesses,
            improvements,
            sentence_feedbacks AS sentenceFeedbacks,
            keyword_analysis AS keywordAnalysis,
            career_analysis AS careerAnalysis,
            job_match AS jobMatch,
            summary,
            recommended_actions AS recommendedActions,
            feedback_type AS feedbackType,
            analysis_version AS analysisVersion,
            created_at AS createdAt,
            updated_at AS updatedAt
        FROM resume_feedbacks
        WHERE user_id = #{userId}
        ORDER BY created_at DESC
    </select>
    
    <!-- SELECT: 전체 피드백 목록 조회 (최근순) -->
    <select id="selectAllFeedbacks" resultType="ResumeFeedback">
        SELECT 
            feedback_id AS feedbackId,
            resume_id AS resumeId,
            user_id AS userId,
            total_score AS totalScore,
            scores,
            strengths,
            weaknesses,
            improvements,
            sentence_feedbacks AS sentenceFeedbacks,
            keyword_analysis AS keywordAnalysis,
            career_analysis AS careerAnalysis,
            job_match AS jobMatch,
            summary,
            recommended_actions AS recommendedActions,
            feedback_type AS feedbackType,
            analysis_version AS analysisVersion,
            created_at AS createdAt,
            updated_at AS updatedAt
        FROM resume_feedbacks
        ORDER BY created_at DESC
    </select>
    
    <!-- UPDATE: 피드백 수정 -->
    <update id="updateFeedback" parameterType="ResumeFeedback">
        UPDATE resume_feedbacks SET
            total_score = #{totalScore},
            scores = #{scores}::jsonb,
            strengths = #{strengths}::jsonb,
            weaknesses = #{weaknesses}::jsonb,
            improvements = #{improvements}::jsonb,
            sentence_feedbacks = #{sentenceFeedbacks}::jsonb,
            keyword_analysis = #{keywordAnalysis}::jsonb,
            career_analysis = #{careerAnalysis}::jsonb,
            job_match = #{jobMatch}::jsonb,
            summary = #{summary},
            recommended_actions = #{recommendedActions}::jsonb,
            feedback_type = #{feedbackType},
            analysis_version = #{analysisVersion},
            updated_at = CURRENT_TIMESTAMP
        WHERE feedback_id = #{feedbackId}
    </update>
    
    <!-- DELETE: 피드백 삭제 -->
    <delete id="deleteFeedback" parameterType="int">
        DELETE FROM resume_feedbacks
        WHERE feedback_id = #{feedbackId}
    </delete>
    
    <!-- SELECT: 특정 추천 액션을 포함하는 피드백 검색 (JSONB 연산자 사용) -->
    <select id="selectFeedbacksByRecommendedAction" parameterType="String" resultType="ResumeFeedback">
        SELECT 
            feedback_id AS feedbackId,
            resume_id AS resumeId,
            user_id AS userId,
            total_score AS totalScore,
            scores,
            strengths,
            weaknesses,
            improvements,
            sentence_feedbacks AS sentenceFeedbacks,
            keyword_analysis AS keywordAnalysis,
            career_analysis AS careerAnalysis,
            job_match AS jobMatch,
            summary,
            recommended_actions AS recommendedActions,
            feedback_type AS feedbackType,
            analysis_version AS analysisVersion,
            created_at AS createdAt,
            updated_at AS updatedAt
        FROM resume_feedbacks
        WHERE recommended_actions ?? #{action}
        <!-- ?? 연산자: JSONB 배열에 특정 값이 포함되어 있는지 확인 -->
        ORDER BY created_at DESC
    </select>
    
    <!-- SELECT: 피드백 타입별 조회 -->
    <select id="selectFeedbacksByType" parameterType="String" resultType="ResumeFeedback">
        SELECT 
            feedback_id AS feedbackId,
            resume_id AS resumeId,
            user_id AS userId,
            total_score AS totalScore,
            scores,
            strengths,
            weaknesses,
            improvements,
            sentence_feedbacks AS sentenceFeedbacks,
            keyword_analysis AS keywordAnalysis,
            career_analysis AS careerAnalysis,
            job_match AS jobMatch,
            summary,
            recommended_actions AS recommendedActions,
            feedback_type AS feedbackType,
            analysis_version AS analysisVersion,
            created_at AS createdAt,
            updated_at AS updatedAt
        FROM resume_feedbacks
        WHERE feedback_type = #{feedbackType}
        ORDER BY created_at DESC
    </select>
    
    <!-- SELECT: 점수 범위별 피드백 조회 -->
    <select id="selectFeedbacksByScoreRange" resultType="ResumeFeedback">
        SELECT 
            feedback_id AS feedbackId,
            resume_id AS resumeId,
            user_id AS userId,
            total_score AS totalScore,
            scores,
            strengths,
            weaknesses,
            improvements,
            sentence_feedbacks AS sentenceFeedbacks,
            keyword_analysis AS keywordAnalysis,
            career_analysis AS careerAnalysis,
            job_match AS jobMatch,
            summary,
            recommended_actions AS recommendedActions,
            feedback_type AS feedbackType,
            analysis_version AS analysisVersion,
            created_at AS createdAt,
            updated_at AS updatedAt
        FROM resume_feedbacks
        WHERE total_score BETWEEN #{minScore} AND #{maxScore}
        ORDER BY total_score DESC, created_at DESC
    </select>
    
    <!-- SELECT: 최신 피드백 조회 (이력서별) -->
    <select id="selectLatestFeedbackByResumeId" parameterType="int" resultType="ResumeFeedback">
        SELECT 
            feedback_id AS feedbackId,
            resume_id AS resumeId,
            user_id AS userId,
            total_score AS totalScore,
            scores,
            strengths,
            weaknesses,
            improvements,
            sentence_feedbacks AS sentenceFeedbacks,
            keyword_analysis AS keywordAnalysis,
            career_analysis AS careerAnalysis,
            job_match AS jobMatch,
            summary,
            recommended_actions AS recommendedActions,
            feedback_type AS feedbackType,
            analysis_version AS analysisVersion,
            created_at AS createdAt,
            updated_at AS updatedAt
        FROM resume_feedbacks
        WHERE resume_id = #{resumeId}
        ORDER BY created_at DESC
        LIMIT 1
    </select>
    
    <!-- SELECT: 피드백 개수 조회 -->
    <select id="countFeedbacks" parameterType="Integer" resultType="int">
        SELECT COUNT(*)
        FROM resume_feedbacks
        <if test="resumeId != null">
            WHERE resume_id = #{resumeId}
        </if>
    </select>
    
    <!-- SELECT: 분석 버전별 피드백 조회 -->
    <select id="selectFeedbacksByAnalysisVersion" parameterType="String" resultType="ResumeFeedback">
        SELECT 
            feedback_id AS feedbackId,
            resume_id AS resumeId,
            user_id AS userId,
            total_score AS totalScore,
            scores,
            strengths,
            weaknesses,
            improvements,
            sentence_feedbacks AS sentenceFeedbacks,
            keyword_analysis AS keywordAnalysis,
            career_analysis AS careerAnalysis,
            job_match AS jobMatch,
            summary,
            recommended_actions AS recommendedActions,
            feedback_type AS feedbackType,
            analysis_version AS analysisVersion,
            created_at AS createdAt,
            updated_at AS updatedAt
        FROM resume_feedbacks
        WHERE analysis_version = #{analysisVersion}
        ORDER BY created_at DESC
    </select>

</mapper>
